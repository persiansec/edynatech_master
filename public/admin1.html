<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø³ÛŒØ³ØªÙ… Ø§Ù†Ø¨Ø§Ø± â€” Ù†Ø³Ø®Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ø§Ø¬Ø¨Ø§Ø±ÛŒ</title>
<style>
@font-face {
  font-family: 'Estedad';
  src: url('https://cdn.fontcdn.ir/Font/Persian/Estedad/Estedad.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}
:root{
  --bg:#f5f7fb;
  --card:#fff;
  --primary:#0b74de;
  --muted:#666;
}
html,body{height:100%}
body{
  font-family: Estedad, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background:var(--bg);
  margin:0;padding:14px;direction:rtl;color:#111;
  -webkit-font-smoothing:antialiased;
}
.card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:14px}
h1{font-size:22px;margin:0 0 6px}
h2{font-size:18px;margin:0 0 8px}
label{display:block;margin-top:8px;font-weight:700}
input,select,textarea,button{font-family:inherit}
input,select,textarea{width:100%;padding:12px;border:1px solid #e0e6ee;border-radius:8px;margin-top:6px;box-sizing:border-box;font-size:16px}
textarea{resize:vertical}
.row{display:flex;gap:10px}
.col{flex:1}
button{padding:10px 14px;border-radius:8px;border:0;background:var(--primary);color:#fff;cursor:pointer;font-size:15px}
button.secondary{background:#6c757d}
button.danger{background:#d9534f}
button:disabled{opacity:0.5;cursor:not-allowed}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.small{font-size:13px;color:var(--muted)}
.table-wrap{overflow:auto;max-height:340px}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{border:1px solid #f0f3f8;padding:8px;text-align:center}
.inline-small{display:inline-block;padding:6px 8px;border-radius:6px;background:#f1f5fa;margin-left:6px}
.canvas-card{height:260px}
.stats-row{display:flex;gap:12px;flex-wrap:wrap}
.stat{background:#fff;padding:12px;border-radius:8px;min-width:160px;box-shadow:0 1px 6px rgba(0,0,0,.04)}
.stat .num{font-size:20px;font-weight:800}
.manage-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.manage-item{background:#f8fafc;padding:6px 10px;border-radius:8px}
.error-box{background:#fee;border:1px solid #f5c6cb;color:#721c24;padding:10px;border-radius:8px;margin:10px 0;font-size:12px;font-family:monospace;white-space:pre-wrap;max-height:200px;overflow:auto}
.success-box{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:10px;border-radius:8px;margin:10px 0}
.warning-box{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:10px;border-radius:8px;margin:10px 0}
.info-box{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460;padding:10px;border-radius:8px;margin:10px 0}
.hidden{display:none !important}
@media (max-width:700px){
  .row{flex-direction:column}
  .stats-row{flex-direction:column}
}
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<!-- Modal ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ -->
<div id="syncModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:#fff; padding:25px; width:90%; max-width:500px; border-radius:10px; text-align:center; max-height:90%; overflow:auto;">
    <h3 id="syncModalTitle">Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</h3>
    <div id="syncModalContent" style="margin:20px 0;"></div>
    <div id="syncProgress" style="margin:15px 0; display:none;">
      <div style="width:100%; background:#eee; border-radius:10px; height:20px;">
        <div id="progressBar" style="width:0%; background:#0b74de; height:100%; border-radius:10px; transition:width 0.3s;"></div>
      </div>
      <div id="progressText" style="margin-top:5px; font-size:13px;">0%</div>
    </div>
    <button onclick="closeSyncModal()" style="padding:10px 30px; margin-top:15px;">Ø¨Ø§Ø´Ù‡</button>
  </div>
</div>

<!-- ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† -->
<div id="loginScreen" class="card">
  <h1 style="text-align:center; color:#0b74de;">ğŸ” Ø³ÛŒØ³ØªÙ… Ø§Ù†Ø¨Ø§Ø±</h1>
  <p style="text-align:center; color:#666; margin-bottom:30px;">Ù†Ø³Ø®Ù‡ Ø¨Ø§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø§Ø¬Ø¨Ø§Ø±ÛŒ</p>
  
  <div class="info-box" style="text-align:center;">
    <strong>âš ï¸ ØªÙˆØ¬Ù‡:</strong> Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³ÛŒØ³ØªÙ…ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.<br>
    <small>Ø­ØªÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø± Ø¢ÙÙ„Ø§ÛŒÙ† Ù†ÛŒØ² Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯ Ø¯Ø§Ø±ÛŒØ¯.</small>
  </div>
  
  <div id="authPanel" style="margin-top:20px;">
    <div class="row">
      <div class="col">
        <label>Ø§ÛŒÙ…ÛŒÙ„</label>
        <input id="authEmail" type="email" placeholder="example@domain.com" />
      </div>
      <div class="col">
        <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
        <input id="authPassword" type="password" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ±" />
      </div>
    </div>
    
    <div class="controls" style="margin-top:25px; justify-content:center; gap:15px;">
      <button onclick="handleSignIn()" style="padding:12px 35px; font-size:16px;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</button>
      <button onclick="handleSignUp()" class="secondary" style="padding:12px 35px; font-size:16px;">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</button>
    </div>
    
    <div id="loginError" class="error-box hidden" style="margin-top:20px;"></div>
    
    <div style="text-align:center; margin-top:25px; color:#666; font-size:13px;">
      <p>Ø¨Ø§ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…ØŒ Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯:</p>
      <ul style="text-align:right; padding-right:20px;">
        <li>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¢ÙÙ„Ø§ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯</li>
        <li>Ø§Ø² Ú†Ù†Ø¯ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</li>
        <li>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡Ù…Ú¯Ø§Ù… Ú©Ù†ÛŒØ¯</li>
        <li>Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯</li>
      </ul>
    </div>
  </div>
</div>

<!-- Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ØµÙ„ÛŒ (Ù…Ø®ÙÛŒ Ø´Ø¯Ù‡ ØªØ§ Ø²Ù…Ø§Ù† Ù„Ø§Ú¯ÛŒÙ†) -->
<div id="mainApp" class="hidden">
  <!-- Ù†ÙˆØ§Ø± ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± -->
  <div class="card" style="background:#f8f9fa; padding:12px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h1 style="margin:0; font-size:20px;">Ø³ÛŒØ³ØªÙ… Ø§Ù†Ø¨Ø§Ø± â€” Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</h1>
        <div class="small">Ú©Ø§Ø±Ø¨Ø±: <span id="currentUserEmail">â€”</span></div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div id="connectionBadge" style="padding:5px 10px; border-radius:20px; font-size:12px; background:#e9ecef;">â—</div>
        <button onclick="handleSignOut()" class="danger" style="font-size:14px;">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <!-- Ù¾Ù†Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ -->
  <div class="card">
    <h2>Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø¨Ø±ÛŒ Ø¨Ø§ Supabase</h2>
    
    <div id="userInfo" style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:8px;">
      <div class="small"><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> <span id="authStatus" style="color:green;">ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡</span></div>
      <div class="small"><strong>Ø§ØªØµØ§Ù„:</strong> <span id="syncStatus">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</span></div>
    </div>
    
    <div class="controls">
      <button onclick="syncLocalToSupabase()" id="syncUpBtn" disabled>ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ Ø³Ø±ÙˆØ±</button>
      <button onclick="loadDataFromSupabase()" id="syncDownBtn" disabled class="secondary">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø² Ø³Ø±ÙˆØ±</button>
      <button onclick="syncUsersAndProducts()" id="syncUsersBtn" disabled class="secondary">ğŸ‘¥ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†/Ú©Ø§Ù„Ø§Ù‡Ø§</button>
      <button onclick="checkSupabaseTables()" class="secondary">ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø¯Ø§ÙˆÙ„</button>
      <button onclick="checkConnection(true)" class="secondary">ğŸ”„ Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„</button>
      <button onclick="viewSyncLog()" class="secondary">ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</button>
    </div>
    
    <div id="errorContainer" style="margin-top:10px;"></div>
  </div>

  <!-- ÙØ±Ù… Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯ -->
  <div class="card">
    <h2>ÙØ±Ù… Ø«Ø¨Øª / ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ú©ÙˆØ±Ø¯</h2>
    <div id="form">
      <div class="row">
        <div class="col">
          <label>ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</label>
          <input id="date_sh" placeholder="Û±Û´Û°Û´/Û°Û±/Û°Û±" />
        </div>
        <div class="col">
          <label>Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</label>
          <select id="registerer"></select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</label>
          <select id="product_select"></select>
        </div>
        <div class="col">
          <label>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</label>
          <input id="product_new" placeholder="Ù†Ø§Ù… Ú©Ø§Ù„Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ùˆ Ø³Ù¾Ø³ Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª</label>
          <select id="operation">
            <option>ÙˆØ±ÙˆØ¯ Ú©Ø§Ù„Ø§</option>
            <option>Ø®Ø±ÙˆØ¬ Ú©Ø§Ù„Ø§</option>
            <option>Ù…ØµØ±Ù Ù‚Ø·Ø¹Ù‡</option>
            <option>ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡</option>
            <option>ØªØ­ÙˆÛŒÙ„ Ø§Ø² ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡</option>
            <option>Ù…Ø±Ø¬ÙˆØ¹ÛŒ</option>
            <option>Ø§Ø³Ù‚Ø§Ø·</option>
            <option>ØªØ¹Ù…ÛŒØ± Ø´Ø¯Ù‡</option>
          </select>
        </div>
        <div class="col">
          <label>ØªØ¹Ø¯Ø§Ø¯</label>
          <input id="amount" type="number" step="any" />
        </div>
      </div>

      <div class="row">
        <div class="col"><label>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„ / Ù¾Ø§Ø±Øª Ù†Ø§Ù…Ø¨Ø±</label><input id="serial" /></div>
        <div class="col"><label>Ø´Ø±Ú©Øª</label><input id="company" /></div>
      </div>

      <label>ØªØ­ÙˆÛŒÙ„â€ŒØ¯Ù‡Ù†Ø¯Ù‡</label>
      <input id="deliverer" />
      <label>ØªØ­ÙˆÛŒÙ„â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡</label>
      <input id="receiver" />
      <label>Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ú©Ø§Ø±ÙØ±Ù…Ø§</label>
      <input id="employer_rep" />
      <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
      <textarea id="description" rows="3"></textarea>

      <div class="controls">
        <button id="saveBtn" onclick="saveRecord()">Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
        <button class="secondary" onclick="clearForm()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
        <button class="secondary" id="cancelEditBtn" style="display:none" onclick="cancelEdit()">Ù„ØºÙˆ ÙˆÛŒØ±Ø§ÛŒØ´</button>
      </div>

      <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
      <div style="margin-top:10px">
        <strong>Ù…Ø¯ÛŒØ±ÛŒØª Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§:</strong>
        <div class="small">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ØŒ ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯.</div>
        <div style="margin-top:8px" class="row">
          <div class="col"><input id="new_user_input" placeholder="Ù†Ø§Ù… Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯..." /></div>
          <div style="width:160px">
            <button class="secondary" onclick="addUserFromInput()">Ø§ÙØ²ÙˆØ¯Ù† Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</button>
          </div>
        </div>
        <div id="user_controls" class="manage-list"></div>
      </div>

      <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§ -->
      <div style="margin-top:12px">
        <strong>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ø§Ù‡Ø§:</strong>
        <div class="small">Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆÙ†Ø¯ Ø¯Ø± Ù„ÛŒØ³Øª Ú©Ø´ÙˆÛŒÛŒ Ù†Ø§Ù… Ú©Ø§Ù„Ø§ Ø¸Ø§Ù‡Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù†Ø§Ù…â€ŒÙ‡Ø§ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯.</div>
        <div style="margin-top:8px" id="product_controls" class="manage-list"></div>
        <div style="margin-top:8px"><button class="secondary" onclick="openProductsPanel()">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„ Ú©Ø§Ù„Ø§Ù‡Ø§</button></div>
      </div>
    </div>
  </div>

  <!-- ÙÙ‡Ø±Ø³Øª Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ Ùˆ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ -->
  <div class="card">
    <h2>ÙÙ‡Ø±Ø³Øª Ø³ÙˆØ§Ø¨Ù‚ Ùˆ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§</h2>
    <div class="controls">
      <input id="search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù†Ø§Ù… Ú©Ø§Ù„Ø§ ÛŒØ§ Ø³Ø±ÛŒØ§Ù„..." oninput="renderList()" />
      <select id="filter_op" onchange="renderList()">
        <option>Ù‡Ù…Ù‡</option>
        <option>ÙˆØ±ÙˆØ¯ Ú©Ø§Ù„Ø§</option>
        <option>Ø®Ø±ÙˆØ¬ Ú©Ø§Ù„Ø§</option>
        <option>Ù…ØµØ±Ù Ù‚Ø·Ø¹Ù‡</option>
        <option>ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡</option>
        <option>ØªØ­ÙˆÛŒÙ„ Ø§Ø² ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡</option>
        <option>Ù…Ø±Ø¬ÙˆØ¹ÛŒ</option>
        <option>Ø§Ø³Ù‚Ø§Ø·</option>
        <option>ØªØ¹Ù…ÛŒØ± Ø´Ø¯Ù‡</option>
      </select>
      <input id="filter_comp" placeholder="ÙÛŒÙ„ØªØ± Ø´Ø±Ú©Øª..." oninput="renderList()" />
      <button class="secondary" onclick="clearFilters()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
    </div>

    <div class="table-wrap">
      <table id="records_table">
        <thead><tr id="thead_row"></tr></thead>
        <tbody id="records_body"></tbody>
      </table>
    </div>

    <div class="controls" style="margin-top:8px">
      <button onclick="exportJSON()">Ù¾Ø´ØªÛŒØ¨Ø§Ù† JSON</button>
      <button onclick="importJSON()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² JSON</button>
      <button onclick="exportXLSX()">Ø®Ø±ÙˆØ¬ÛŒ XLSX</button>
      <button onclick="exportPDF()">Ø®Ø±ÙˆØ¬ÛŒ PDF</button>
      <button onclick="calcBalance()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ±Ø§Ø²</button>
      <button onclick="syncLocalToSupabase()" class="secondary">Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ø³Ø±ÙˆØ±</button>
      <button class="danger" onclick="clearAllData()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
    </div>
  </div>

  <!-- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ -->
  <div class="card">
    <h2>Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ùˆ Ø¢Ù…Ø§Ø±</h2>
    <div class="stats-row">
      <div class="stat">
        <div class="small">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ù‚Ù„Ø§Ù… (Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø«Ø¨Øª Ù…Ø¬Ù…ÙˆØ¹)</div>
        <div id="total_parts" class="num">â€”</div>
      </div>
      <div style="flex:1" class="canvas-card card">
        <div class="small">Ûµ Ø´Ø±Ú©Øª Ø¨Ø±ØªØ± (Ù†Ø³Ø¨ØªÛŒ)</div>
        <canvas id="companyPie"></canvas>
      </div>
      <div style="flex:1" class="canvas-card card">
        <div class="small">Ûµ Ú©Ø§Ù„Ø§ÛŒ Ù¾Ø±Ù…ØµØ±Ù (Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù…ÙˆØ¬ÙˆØ¯ÛŒ) - Ù†Ù…ÙˆØ¯Ø§Ø± Ø¹Ù…ÙˆØ¯ÛŒ</div>
        <canvas id="topItemsBar"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„ Ú©Ø§Ù„Ø§ -->
<div id="productModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999;">
  <div style="background:#fff; padding:20px; width:400px; max-height:80%; overflow:auto; border-radius:8px; position:relative;">
    <h3>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„ Ú©Ø§Ù„Ø§Ù‡Ø§</h3>
    <div id="productListModal"></div>
    <input id="newProductModal" placeholder="Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯..." style="margin-top:10px">
    <div style="margin-top:10px">
      <button onclick="addProductFromModal()">Ø§ÙØ²ÙˆØ¯Ù†</button>
      <button onclick="closeProductModal()" class="secondary">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</div>

<!-- Modal ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ -->
<div id="syncLogModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:#fff; padding:25px; width:90%; max-width:600px; border-radius:10px; max-height:90%; overflow:auto;">
    <h3 style="margin-top:0;">ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</h3>
    <div id="syncLogContent" style="margin:15px 0; min-height:200px;">
      <div class="info-box" style="text-align:center;">
        Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡...
      </div>
    </div>
    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
      <button onclick="clearSyncLog()" class="danger">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
      <button onclick="closeSyncLogModal()" class="secondary">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</div>

<script>
// ==================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Supabase ====================
const SUPABASE_URL = 'https://vfhpiwiavoigshkrjygk.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmaHBpd2lhdm9pZ3Noa3JqeWdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNjk2NjYsImV4cCI6MjA4MDc0NTY2Nn0.b0ofw_5_ciX_6NYe_oN3jpE_LAiswoQ9nxJ0-DrN4s8';

let supabase = null;
let currentUser = null;
let isOnline = false;
let syncLog = JSON.parse(localStorage.getItem('sync_log') || '[]');

// ==================== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
function showSyncModal(title, content, showProgress = false) {
  document.getElementById('syncModalTitle').textContent = title;
  document.getElementById('syncModalContent').innerHTML = content;
  document.getElementById('syncProgress').style.display = showProgress ? 'block' : 'none';
  document.getElementById('syncModal').style.display = 'flex';
}

function updateProgress(percent) {
  document.getElementById('progressBar').style.width = percent + '%';
  document.getElementById('progressText').textContent = Math.round(percent) + '%';
}

function closeSyncModal() {
  document.getElementById('syncModal').style.display = 'none';
}

function showError(message, details = '') {
  const errorHtml = `
    <div class="error-box">
      <strong>âŒ Ø®Ø·Ø§:</strong> ${message}
      ${details ? `<hr style="margin:5px 0"><small>${details}</small>` : ''}
    </div>
  `;
  
  const errorContainer = document.getElementById('errorContainer');
  if (errorContainer) {
    errorContainer.innerHTML = errorHtml;
    setTimeout(() => {
      errorContainer.innerHTML = '';
    }, 10000);
  }
  
  return errorHtml;
}

function showSuccess(message) {
  const successHtml = `
    <div class="success-box">
      <strong>âœ… Ù…ÙˆÙÙ‚ÛŒØª:</strong> ${message}
    </div>
  `;
  
  const errorContainer = document.getElementById('errorContainer');
  if (errorContainer) {
    errorContainer.innerHTML = successHtml;
    setTimeout(() => {
      errorContainer.innerHTML = '';
    }, 5000);
  }
  
  return successHtml;
}

function addToSyncLog(type, message, details = '') {
  const logEntry = {
    timestamp: new Date().toISOString(),
    type: type,
    message: message,
    details: details,
    user: currentUser?.email || 'unknown'
  };
  
  syncLog.unshift(logEntry);
  if (syncLog.length > 100) syncLog = syncLog.slice(0, 100);
  
  localStorage.setItem('sync_log', JSON.stringify(syncLog));
  return logEntry;
}

function viewSyncLog() {
  document.getElementById('syncLogModal').style.display = 'flex';
  renderSyncLog();
}

function closeSyncLogModal() {
  document.getElementById('syncLogModal').style.display = 'none';
}

function clearSyncLog() {
  if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
    syncLog = [];
    localStorage.removeItem('sync_log');
    renderSyncLog();
  }
}

function renderSyncLog() {
  const container = document.getElementById('syncLogContent');
  
  if (syncLog.length === 0) {
    container.innerHTML = '<div class="info-box" style="text-align:center;">ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
    return;
  }
  
  let html = '<div style="max-height:400px; overflow:auto;">';
  
  syncLog.forEach((log, index) => {
    const date = new Date(log.timestamp).toLocaleString('fa-IR');
    const badgeColor = {
      'success': 'green',
      'error': 'red',
      'warning': 'orange',
      'info': 'blue'
    }[log.type] || 'gray';
    
    html += `
      <div style="border-bottom:1px solid #eee; padding:10px 0; ${index === 0 ? 'border-top:1px solid #eee;' : ''}">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span style="font-size:12px; color:#666;">${date}</span>
          <span style="background:${badgeColor}; color:white; padding:2px 8px; border-radius:10px; font-size:11px;">
            ${log.type === 'success' ? 'âœ…' : log.type === 'error' ? 'âŒ' : log.type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'} ${log.type}
          </span>
        </div>
        <div style="margin-top:5px;"><strong>${log.message}</strong></div>
        ${log.details ? `<div style="margin-top:5px; font-size:11px; color:#666; background:#f5f5f5; padding:5px; border-radius:4px;">${log.details}</div>` : ''}
        <div style="margin-top:5px; font-size:11px; color:#999;">Ú©Ø§Ø±Ø¨Ø±: ${log.user}</div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØªØµØ§Ù„ ====================
async function initSupabase() {
  try {
    console.log('Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase...');
    
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage
      }
    });
    
    // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ø§ÛŒÙ…ÛŒÙ„
    if (window.location.hash.includes('access_token') || window.location.hash.includes('type=recovery')) {
      console.log('Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø² Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯');
      
      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) {
          console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§Ø²Ú¯Ø´Øª:', error);
        } else if (data.session) {
          console.log('Session Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯:', data.session.user.email);
          currentUser = data.session.user;
          window.history.replaceState({}, document.title, window.location.pathname);
          showUserInfo(data.session.user);
          await loadMainApp();
          return true;
        }
      } catch (e) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ø§ÛŒÙ…ÛŒÙ„:', e);
      }
    }
    
    const { data: sessionData } = await supabase.auth.getSession();
    if (sessionData.session) {
      console.log('Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù‚Ø¨Ù„ Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯Ù‡:', sessionData.session.user.email);
      currentUser = sessionData.session.user;
    }
    
    isOnline = true;
    updateConnectionStatus('Ù…ØªØµÙ„ Ø¨Ù‡ Ø³Ø±ÙˆØ±', 'success');
    addToSyncLog('success', 'Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯');
    
    console.log('Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯');
    return true;
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase:', error);
    isOnline = false;
    updateConnectionStatus('Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†', 'warning');
    addToSyncLog('warning', 'Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª', error.message);
    
    try {
      const sessionStr = localStorage.getItem(`sb-${SUPABASE_URL.replace('https://', '').split('.')[0]}-auth-token`);
      if (sessionStr) {
        const session = JSON.parse(sessionStr);
        if (session?.currentSession?.user) {
          console.log('Ú©Ø§Ø±Ø¨Ø± Ø§Ø² localStorage Ù¾ÛŒØ¯Ø§ Ø´Ø¯:', session.currentSession.user.email);
          currentUser = session.currentSession.user;
          showUserInfo(session.currentSession.user);
        }
      }
    } catch (e) {
      console.warn('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† session Ø§Ø² localStorage:', e.message);
    }
    
    return false;
  }
}

function updateConnectionStatus(message, type = 'info') {
  const statusEl = document.getElementById('syncStatus');
  const badgeEl = document.getElementById('connectionBadge');
  
  if (statusEl) {
    statusEl.textContent = message;
    const colors = {
      success: 'green',
      error: 'red',
      warning: 'orange',
      info: 'blue'
    };
    statusEl.style.color = colors[type] || 'black';
  }
  
  if (badgeEl) {
    badgeEl.textContent = isOnline ? 'â— Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'â— Ø¢ÙÙ„Ø§ÛŒÙ†';
    badgeEl.style.background = isOnline ? '#d4edda' : '#fff3cd';
    badgeEl.style.color = isOnline ? '#155724' : '#856404';
  }
  
  const syncUpBtn = document.getElementById('syncUpBtn');
  const syncDownBtn = document.getElementById('syncDownBtn');
  const syncUsersBtn = document.getElementById('syncUsersBtn');
  
  if (syncUpBtn && syncDownBtn && syncUsersBtn) {
    syncUpBtn.disabled = !isOnline;
    syncDownBtn.disabled = !isOnline;
    syncUsersBtn.disabled = !isOnline;
  }
}

// ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ====================
async function checkAuthStatus() {
  try {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error) {
      console.log('Ø®Ø·Ø§ Ø¯Ø± getUser:', error.message);
      return false;
    }
    if (user) {
      console.log('Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ø´Ø¯:', user.email);
      currentUser = user;
      showUserInfo(user);
      return true;
    } else {
      console.log('Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª');
      currentUser = null;
      return false;
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª:', error);
    return false;
  }
}

function showUserInfo(user) {
  const userEmailEl = document.getElementById('currentUserEmail');
  if (userEmailEl) userEmailEl.textContent = user.email;
  
  const loginScreen = document.getElementById('loginScreen');
  const mainApp = document.getElementById('mainApp');
  
  if (loginScreen) loginScreen.classList.add('hidden');
  if (mainApp) mainApp.classList.remove('hidden');
  
  loadMainApp();
}

function showLoginScreen() {
  const loginScreen = document.getElementById('loginScreen');
  const mainApp = document.getElementById('mainApp');
  
  if (loginScreen) loginScreen.classList.remove('hidden');
  if (mainApp) mainApp.classList.add('hidden');
}

async function loadMainApp() {
  try {
    await loadUsers(); 
    await loadProductsToSelect(); 
    await renderList(); 
    await calcBalance(); 
    await renderCharts();
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ØµÙ„ÛŒ:', error);
  }
}

// ==================== Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯ ====================
async function handleSignUp() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const errorEl = document.getElementById('loginError');
  
  if (!email || !password) {
    errorEl.textContent = 'Ù„Ø·ÙØ§ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
    errorEl.classList.remove('hidden');
    return;
  }
  
  if (password.length < 6) {
    errorEl.textContent = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯';
    errorEl.classList.remove('hidden');
    return;
  }
  
  try {
    errorEl.classList.add('hidden');
    showSyncModal('Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…', 'Ù„Ø·ÙØ§ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...', true);
    updateProgress(30);
    
    console.log('Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±:', email);
    
    const currentUrl = window.location.origin + window.location.pathname;
    
    const { data, error } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        data: {
          full_name: email.split('@')[0],
          created_at: new Date().toISOString()
        },
        emailRedirectTo: currentUrl
      }
    });
    
    updateProgress(70);
    
    if (error) {
      if (error.message.includes('already registered')) {
        throw new Error('Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª');
      } else if (error.message.includes('invalid email')) {
        throw new Error('Ø§ÛŒÙ…ÛŒÙ„ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
      } else if (error.message.includes('rate limit')) {
        throw new Error('ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø²ÛŒØ§Ø¯ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯');
      } else {
        throw error;
      }
    }
    
    console.log('Ù¾Ø§Ø³Ø® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…:', data);
    updateProgress(100);
    
    if (data.user) {
      addToSyncLog('info', 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¬Ø¯ÛŒØ¯', `Ø§ÛŒÙ…ÛŒÙ„: ${email}`);
      
      if (data.session) {
        currentUser = data.user;
        showUserInfo(data.user);
        closeSyncModal();
        showSyncModal('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚', `
          <div class="success-box" style="text-align:right;">
            <strong>âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯!</strong><br>
            <small>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${email}</small><br>
            <small>Ø´Ù…Ø§ Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒØ¯.</small>
          </div>
        `);
      } else {
        closeSyncModal();
        showSyncModal('Ù„Ø·ÙØ§ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯', `
          <div class="info-box" style="text-align:right;">
            <strong>ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„ ØªØ§ÛŒÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!</strong><br>
            <small>Ù„Ø·ÙØ§ ØµÙ†Ø¯ÙˆÙ‚ Ø§ÛŒÙ…ÛŒÙ„ <strong>${email}</strong> Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</small><br>
            <small>Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© ØªØ§ÛŒÛŒØ¯ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ ÙˆØ§Ø±Ø¯ Ø³ÛŒØ³ØªÙ… Ø´ÙˆÛŒØ¯.</small>
          </div>
        `);
      }
      
      document.getElementById('authEmail').value = '';
      document.getElementById('authPassword').value = '';
    } else {
      throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±');
    }
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…:', error);
    errorEl.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ${error.message}`;
    errorEl.classList.remove('hidden');
    addToSyncLog('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…', error.message);
    closeSyncModal();
  }
}

async function handleSignIn() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const errorEl = document.getElementById('loginError');
  
  if (!email || !password) {
    errorEl.textContent = 'Ù„Ø·ÙØ§ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
    errorEl.classList.remove('hidden');
    return;
  }
  
  try {
    errorEl.classList.add('hidden');
    showSyncModal('Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯', 'Ù„Ø·ÙØ§ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...', true);
    updateProgress(30);
    
    console.log('Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±:', email);
    
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });
    
    updateProgress(70);
    
    if (error) {
      if (error.message.includes('Invalid login credentials')) {
        throw new Error('Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
      } else if (error.message.includes('Email not confirmed')) {
        throw new Error('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯');
      } else if (error.message.includes('rate limit')) {
        throw new Error('ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø²ÛŒØ§Ø¯ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯');
      } else {
        throw error;
      }
    }
    
    console.log('Ù¾Ø§Ø³Ø® ÙˆØ±ÙˆØ¯:', data);
    updateProgress(100);
    
    currentUser = data.user;
    showUserInfo(data.user);
    
    document.getElementById('authEmail').value = '';
    document.getElementById('authPassword').value = '';
    
    closeSyncModal();
    await checkConnection(false);
    
    addToSyncLog('success', 'ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚', `Ú©Ø§Ø±Ø¨Ø±: ${email}`);
    showSyncModal('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚', `
      <div class="success-box" style="text-align:right;">
        <strong>âœ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒØ¯!</strong><br>
        <small>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${email}</small>
      </div>
    `);
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯:', error);
    errorEl.textContent = `Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}`;
    errorEl.classList.remove('hidden');
    addToSyncLog('error', 'Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯', error.message);
    closeSyncModal();
  }
}

async function handleSignOut() {
  try {
    const { error } = await supabase.auth.signOut();
    
    if (error) {
      addToSyncLog('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬', error.message);
      throw error;
    }
    
    currentUser = null;
    addToSyncLog('info', 'Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…', `Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Ø±Ø¬ Ø´Ø¯`);
    
    showLoginScreen();
    
    showSyncModal('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚', `
      <div class="info-box" style="text-align:right;">
        <strong>Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.</strong><br>
        <small>Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø¬Ø¯Ø¯ Ø§Ø² Ø³ÛŒØ³ØªÙ…ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.</small>
      </div>
    `);
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬:', error);
    showSyncModal('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬', `
      <div class="error-box">
        <strong>Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬:</strong> ${error.message}
      </div>
    `);
    addToSyncLog('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬', error.message);
  }
}

// ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ ====================
async function initApp() {
  try {
    console.log('Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡...');
    showLoginScreen();
    
    console.log('Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase...');
    await initSupabase();
    
    const { data: { user } } = await supabase.auth.getUser();
    
    if (user) {
      console.log('Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù‚Ø¨Ù„ Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯Ù‡:', user.email);
      currentUser = user;
      showUserInfo(user);
    }
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ù†Ø§Ù…Ù‡:', error);
    addToSyncLog('error', 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ù†Ø§Ù…Ù‡', error.message);
    
    showSyncModal('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ', `
      <div class="warning-box" style="text-align:right;">
        <strong>âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±:</strong><br>
        <small>${error.message}</small><br><br>
        <small>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</small>
      </div>
    `);
  }
}

// ==================== ØªÙˆØ§Ø¨Ø¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ====================
async function syncLocalToSupabase() {
  if (!currentUser) {
    showSyncModal('Ø®Ø·Ø§', `<div class="error-box"><strong>Ø®Ø·Ø§:</strong> Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.</div>`);
    return;
  }
  
  if (!isOnline) {
    showSyncModal('Ø®Ø·Ø§', `<div class="error-box"><strong>Ø®Ø·Ø§:</strong> Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª.</div>`);
    return;
  }
  
  try {
    showSyncModal('Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ', 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø³Ø±ÙˆØ±...', true);
    updateProgress(10);
    
    const localRecords = await getAllRecords();
    
    updateProgress(30);
    
    let successCount = 0;
    let errorCount = 0;
    let errors = [];
    
    // Ø±ÙˆØ´ Ø³Ø§Ø¯Ù‡: Ù‡Ø± Ø¨Ø§Ø± ÙÙ‚Ø· ÛŒÚ© Ø±Ú©ÙˆØ±Ø¯ INSERT Ú©Ù†
    for (let i = 0; i < localRecords.length; i++) {
      const record = localRecords[i];
      
      try {
        // ÙÙ‚Ø· ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
        const recordData = {
          date_sh: record.date_sh || '',
          registerer: record.registerer || '',
          operation: record.operation || '',
          product: record.product || '',
          serial: record.serial || '',
          amount: record.amount || 0,
          company: record.company || '',
          deliverer: record.deliverer || '',
          receiver: record.receiver || '',
          employer_rep: record.employer_rep || '',
          description: record.description || '',
          user_id: currentUser.id,
          created_at: record.date_iso || new Date().toISOString()
        };
        
        // Ø§Ø² INSERT Ø³Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† (Ø¨Ø¯ÙˆÙ† upsert)
        const { data, error } = await supabase
          .from('records')
          .insert(recordData);
        
        if (error) {
          throw error;
        }
        
        successCount++;
        
        // Ø¹Ù„Ø§Ù…Øª Ø¨Ø²Ù† Ú©Ù‡ Ù‡Ù…Ú¯Ø§Ù… Ø´Ø¯Ù‡
        record.synced = true;
        await updateRecordInDb(record.id, record);
        
      } catch (error) {
        errorCount++;
        errors.push(`Ø±Ú©ÙˆØ±Ø¯ ${i+1}: ${error.message}`);
      }
      
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ progress bar
      updateProgress(30 + ((i + 1) / localRecords.length * 70));
    }
    
    updateProgress(100);
    
    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡
    let message = `
      <div style="text-align: right;">
        <div class="${successCount > 0 ? 'success-box' : 'warning-box'}">
          <strong>${successCount} Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯</strong>
        </div>
    `;
    
    if (errorCount > 0) {
      message += `
        <div class="warning-box" style="margin-top:10px;">
          <strong>${errorCount} Ø®Ø·Ø§ Ø±Ø® Ø¯Ø§Ø¯</strong>
          <div style="max-height:100px; overflow:auto; font-size:11px; margin-top:5px;">
            ${errors.slice(0, 3).map(e => `â€¢ ${e}`).join('<br>')}
            ${errors.length > 3 ? `<br>Ùˆ ${errors.length - 3} Ø®Ø·Ø§ÛŒ Ø¯ÛŒÚ¯Ø±...` : ''}
          </div>
        </div>
      `;
    }
    
    message += `
      <div style="margin-top:15px; font-size:12px; color:#666;">
        <strong>Ø®Ù„Ø§ØµÙ‡:</strong><br>
        â€¢ Ú©Ù„ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ: ${localRecords.length}<br>
        â€¢ Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÙˆÙÙ‚: ${successCount}<br>
        â€¢ Ø®Ø·Ø§: ${errorCount}
      </div>
    </div>`;
    
    showSyncModal('Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„', message);
    addToSyncLog('success', 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§', `${successCount} Ø±Ú©ÙˆØ±Ø¯ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯`);
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ:', error);
    showSyncModal('Ø®Ø·Ø§', `
      <div class="error-box">
        <strong>Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ:</strong> ${error.message}
      </div>
    `);
    addToSyncLog('error', 'Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ', error.message);
  }
}

async function syncUsersAndProducts() {
  try {
    showSyncModal('Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ú©Ø§Ù„Ø§Ù‡Ø§', 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...', true);
    
    const localUsers = await getAllUsers();
    const localProducts = await getAllProducts();
    
    let results = '';
    let successCount = 0;
    
    // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    if (localUsers.length > 0) {
      for (const user of localUsers) {
        try {
          const { error } = await supabase
            .from('users')
            .insert({ name: user.name, user_id: currentUser.id });
          
          if (!error) {
            results += `âœ… Ú©Ø§Ø±Ø¨Ø± "${user.name}" Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯<br>`;
            successCount++;
          }
        } catch (e) {
          results += `âš ï¸ Ú©Ø§Ø±Ø¨Ø± "${user.name}": ${e.message}<br>`;
        }
      }
    }
    
    // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù„Ø§Ù‡Ø§
    if (localProducts.length > 0) {
      for (const product of localProducts) {
        try {
          const { error } = await supabase
            .from('products')
            .insert({ name: product.name, user_id: currentUser.id });
          
          if (!error) {
            results += `âœ… Ú©Ø§Ù„Ø§ "${product.name}" Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯<br>`;
            successCount++;
          }
        } catch (e) {
          results += `âš ï¸ Ú©Ø§Ù„Ø§ "${product.name}": ${e.message}<br>`;
        }
      }
    }
    
    showSyncModal('Ù†ØªÛŒØ¬Ù‡', `
      <div style="text-align: right; max-height:300px; overflow:auto;">
        <div class="success-box">
          <strong>${successCount} Ø¢ÛŒØªÙ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯</strong>
        </div>
        <div style="margin-top:10px; font-size:13px;">
          ${results || 'Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª'}
        </div>
      </div>
    `);
    
    addToSyncLog('success', 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ú©Ø§Ù„Ø§Ù‡Ø§', `${successCount} Ø¢ÛŒØªÙ… Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯`);
    
  } catch (error) {
    showSyncModal('Ø®Ø·Ø§', `<div class="error-box">${error.message}</div>`);
    addToSyncLog('error', 'Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ú©Ø§Ù„Ø§Ù‡Ø§', error.message);
  }
}

async function checkSupabaseTables() {
  try {
    showSyncModal('Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø¯Ø§ÙˆÙ„', 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³...', true);
    
    const tables = ['records', 'users', 'products'];
    let results = '';
    
    for (const table of tables) {
      try {
        const { data, error } = await supabase
          .from(table)
          .select('count')
          .limit(1);
        
        if (error) {
          results += `âŒ Ø¬Ø¯ÙˆÙ„ "${table}": ${error.message}<br>`;
        } else {
          const { count } = await supabase
            .from(table)
            .select('*', { count: 'exact', head: true })
            .eq('user_id', currentUser.id);
          
          results += `âœ… Ø¬Ø¯ÙˆÙ„ "${table}" Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª (${count || 0} Ø±Ú©ÙˆØ±Ø¯ Ø´Ù…Ø§)<br>`;
        }
      } catch (e) {
        results += `âš ï¸ Ø¬Ø¯ÙˆÙ„ "${table}": ${e.message}<br>`;
      }
    }
    
    showSyncModal('Ù†ØªØ§ÛŒØ¬ Ø¨Ø±Ø±Ø³ÛŒ', `
      <div style="text-align: right; max-height:400px; overflow:auto;">
        <div class="info-box">
          <strong>ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯Ø§ÙˆÙ„ Supabase</strong>
        </div>
        <div style="margin-top:10px; font-size:13px;">
          ${results}
        </div>
      </div>
    `);
    
  } catch (error) {
    showSyncModal('Ø®Ø·Ø§', `<div class="error-box">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø¯Ø§ÙˆÙ„: ${error.message}</div>`);
  }
}

async function loadDataFromSupabase() {
  if (!currentUser) {
    showSyncModal('Ø®Ø·Ø§', `<div class="error-box"><strong>Ø®Ø·Ø§:</strong> Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.</div>`);
    return;
  }
  
  if (!isOnline) {
    showSyncModal('Ø®Ø·Ø§', `<div class="error-box"><strong>Ø®Ø·Ø§:</strong> Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª.</div>`);
    return;
  }
  
  try {
    showSyncModal('Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡', 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±...', true);
    updateProgress(10);
    
    updateProgress(30);
    const [recordsResponse, usersResponse, productsResponse] = await Promise.allSettled([
      supabase.from('records').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }),
      supabase.from('users').select('*').eq('user_id', currentUser.id),
      supabase.from('products').select('*').eq('user_id', currentUser.id)
    ]);
    
    updateProgress(60);
    
    const errors = [];
    let records = [], users = [], products = [];
    
    if (recordsResponse.status === 'fulfilled' && !recordsResponse.value.error) {
      records = recordsResponse.value.data || [];
    } else if (recordsResponse.status === 'rejected') {
      errors.push(`Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: ${recordsResponse.reason.message}`);
    } else if (recordsResponse.value.error) {
      errors.push(`Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: ${recordsResponse.value.error.message}`);
    }
    
    if (usersResponse.status === 'fulfilled' && !usersResponse.value.error) {
      users = usersResponse.value.data || [];
    } else if (usersResponse.status === 'rejected') {
      errors.push(`Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: ${usersResponse.reason.message}`);
    } else if (usersResponse.value.error) {
      errors.push(`Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: ${usersResponse.value.error.message}`);
    }
    
    if (productsResponse.status === 'fulfilled' && !productsResponse.value.error) {
      products = productsResponse.value.data || [];
    } else if (productsResponse.status === 'rejected') {
      errors.push(`Ú©Ø§Ù„Ø§Ù‡Ø§: ${productsResponse.reason.message}`);
    } else if (productsResponse.value.error) {
      errors.push(`Ú©Ø§Ù„Ø§Ù‡Ø§: ${productsResponse.value.error.message}`);
    }
    
    updateProgress(70);
    await clearStore();
    
    updateProgress(80);
    for (const record of records) {
      await addRecordToDb({ ...record, synced: true });
    }
    
    for (const user of users) {
      await addUser(user.name);
    }
    
    for (const product of products) {
      await addProduct(product.name);
    }
    
    updateProgress(90);
    await loadUsers();
    await loadProductsToSelect();
    await renderList();
    await calcBalance();
    await renderCharts();
    
    updateProgress(100);
    
    const errorsHtml = errors.length > 0 ? `
      <div class="warning-box" style="margin-top:10px;">
        <strong>Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¬Ø²Ø¦ÛŒ:</strong><br>
        ${errors.map(err => `â€¢ ${err}`).join('<br>')}
      </div>
    ` : '';
    
    const message = `
      <div style="text-align: right; line-height: 1.8;">
        <div><strong>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù†Ø¯:</strong></div>
        <div class="success-box" style="margin:10px 0;">
          ğŸ“Š ${records.length} Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯<br>
          ğŸ‘¥ ${users.length} Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯<br>
          ğŸ“¦ ${products.length} Ú©Ø§Ù„Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯
        </div>
        ${errorsHtml}
      </div>
    `;
    
    addToSyncLog('success', 'Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±', `${records.length} Ø±Ú©ÙˆØ±Ø¯ØŒ ${users.length} Ú©Ø§Ø±Ø¨Ø±ØŒ ${products.length} Ú©Ø§Ù„Ø§`);
    showSyncModal('Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù…Ù„', message);
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
    const errorHtml = `
      <div class="error-box">
        <strong>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:</strong> ${error.message}
      </div>
    `;
    addToSyncLog('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±', error.message);
    showSyncModal('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª', errorHtml);
  }
}

// ==================== IndexedDB Setup ====================
const DB_NAME='anbar_db_secured_v1';
let db=null;

async function openDb(){
  return new Promise((res,rej)=>{
    const rq=indexedDB.open(DB_NAME,7);
    rq.onupgradeneeded=e=>{
      db=e.target.result;
      if(!db.objectStoreNames.contains('records')){
        const st=db.createObjectStore('records',{keyPath:'id',autoIncrement:true});
        st.createIndex('product','product',{unique:false});
        st.createIndex('synced','synced',{unique:false});
      }
      if(!db.objectStoreNames.contains('users')) db.createObjectStore('users',{keyPath:'id',autoIncrement:true});
      if(!db.objectStoreNames.contains('products')) db.createObjectStore('products',{keyPath:'id',autoIncrement:true});
    };
    rq.onsuccess=e=>{ db=e.target.result; res(db); };
    rq.onerror=e=>rej(e);
  });
}

async function addRecordToDb(r){
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction(['records'],'readwrite'); 
    const st=tx.objectStore('records'); 
    r.date_iso=new Date().toISOString(); 
    r.synced = r.synced || false;
    r.user_id = currentUser?.id;
    st.add(r); 
    tx.oncomplete=()=>res(true); 
    tx.onerror=e=>rej(e);
  });
}

async function updateRecordInDb(id, r){
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction(['records'],'readwrite'); 
    const st=tx.objectStore('records'); 
    r.id = id;
    r.date_iso = r.date_iso || new Date().toISOString();
    st.put(r); 
    tx.oncomplete=()=>res(true); 
    tx.onerror=e=>rej(e);
  });
}

async function getAllRecords(){
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction('records','readonly'); 
    const st=tx.objectStore('records'); 
    const all=st.getAll(); 
    all.onsuccess=()=>{
      const userRecords = (all.result||[]).filter(r => !r.user_id || r.user_id === currentUser?.id);
      res(userRecords);
    }; 
    all.onerror=e=>rej(e);
  });
}

async function clearStore(){
  await openDb(); 
  return new Promise(r=>{
    const tx=db.transaction(['records', 'users', 'products'],'readwrite'); 
    tx.objectStore('records').clear(); 
    tx.objectStore('users').clear(); 
    tx.objectStore('products').clear(); 
    tx.oncomplete=r;
  });
}

async function addUser(name){
  if(!name) return; 
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction('users','readwrite'); 
    tx.objectStore('users').add({name, user_id: currentUser?.id}); 
    tx.oncomplete=()=>res(true); 
    tx.onerror=e=>rej(e);
  });
}

async function getAllUsers(){
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction('users','readonly'); 
    const st=tx.objectStore('users'); 
    st.getAll().onsuccess=e=>{
      const userUsers = (e.target.result||[]).filter(u => !u.user_id || u.user_id === currentUser?.id);
      res(userUsers);
    }; 
    st.getAll().onerror=e=>rej(e);
  });
}

async function updateUser(id, name){
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction('users','readwrite'); 
    tx.objectStore('users').put({id, name, user_id: currentUser?.id}); 
    tx.oncomplete=()=>res(true); 
    tx.onerror=e=>rej(e);
  });
}

async function deleteUser(id){
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction('users','readwrite'); 
    tx.objectStore('users').delete(id); 
    tx.oncomplete=()=>res(true); 
    tx.onerror=e=>rej(e);
  });
}

async function addProduct(name){
  if(!name) return; 
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction('products','readwrite'); 
    tx.objectStore('products').add({name, user_id: currentUser?.id}); 
    tx.oncomplete=()=>res(true); 
    tx.onerror=e=>rej(e);
  });
}

async function getAllProducts(){
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction('products','readonly'); 
    tx.objectStore('products').getAll().onsuccess=e=>{
      const userProducts = (e.target.result||[]).filter(p => !p.user_id || p.user_id === currentUser?.id);
      res(userProducts);
    }; 
    tx.objectStore('products').getAll().onerror=e=>rej(e);
  });
}

async function updateProduct(id, name){
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction('products','readwrite'); 
    tx.objectStore('products').put({id, name, user_id: currentUser?.id}); 
    tx.oncomplete=()=>res(true); 
    tx.onerror=e=>rej(e);
  });
}

async function deleteProduct(id){
  await openDb(); 
  return new Promise((res,rej)=>{
    const tx=db.transaction('products','readwrite'); 
    tx.objectStore('products').delete(id); 
    tx.oncomplete=()=>res(true); 
    tx.onerror=e=>rej(e);
  });
}

// ==================== ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ====================
let editingId=null;
function clearForm(){
  ['date_sh','product_select','serial','amount','company','deliverer','receiver','employer_rep','description'].forEach(id=>{
    document.getElementById(id).value='';
  });
}

function cancelEdit(){
  editingId=null; 
  document.getElementById('saveBtn').textContent='Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª'; 
  document.getElementById('cancelEditBtn').style.display='none'; 
  clearForm();
}

async function saveRecord(){
  if (!currentUser) {
    showSyncModal('Ø®Ø·Ø§', `<div class="error-box"><strong>Ø®Ø·Ø§:</strong> Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.</div>`);
    return;
  }
  
  const rec={
    date_sh:document.getElementById('date_sh').value||'',
    registerer:document.getElementById('registerer').value||'',
    operation:document.getElementById('operation').value,
    product:document.getElementById('product_select').value||'',
    serial:document.getElementById('serial').value||'',
    amount:parseFloat(document.getElementById('amount').value||'0')||0,
    company:document.getElementById('company').value||'',
    deliverer:document.getElementById('deliverer').value||'',
    receiver:document.getElementById('receiver').value||'',
    employer_rep:document.getElementById('employer_rep').value||'',
    description:document.getElementById('description').value||'',
    synced: false
  };
  
  if(!rec.product || !rec.amount || !rec.operation){
    showSyncModal('Ø®Ø·Ø§', `<div class="error-box"><strong>Ø®Ø·Ø§:</strong> ÙÛŒÙ„Ø¯ Ú©Ø§Ù„Ø§ØŒ ØªØ¹Ø¯Ø§Ø¯ Ùˆ Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ù‡Ø³ØªÙ†Ø¯.</div>`);
    return;
  }
  
  try {
    if(editingId){ 
      await updateRecordInDb(editingId,rec); 
      addToSyncLog('info', 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ú©ÙˆØ±Ø¯', `Ø±Ú©ÙˆØ±Ø¯ #${editingId} ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯`);
      editingId=null; 
      document.getElementById('saveBtn').textContent='Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª'; 
      document.getElementById('cancelEditBtn').style.display='none'; 
      showSuccess('ÙˆÛŒØ±Ø§ÛŒØ´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
    } else { 
      await addRecordToDb(rec); 
      addToSyncLog('info', 'Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯', `Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯`);
      showSuccess('Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯');
    }
    
    clearForm(); 
    renderList(); 
    calcBalance(); 
    renderCharts();
    
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡:', error);
    showSyncModal('Ø®Ø·Ø§', `<div class="error-box"><strong>Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª:</strong> ${error.message}</div>`);
    addToSyncLog('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø±Ú©ÙˆØ±Ø¯', error.message);
  }
}

async function renderList(){
  try {
    const all=await getAllRecords();
    const search=document.getElementById('search').value.toLowerCase();
    const opFilter=document.getElementById('filter_op').value;
    const compFilter=document.getElementById('filter_comp').value.toLowerCase();
    
    let data=all.filter(r=>
      (!opFilter||opFilter==='Ù‡Ù…Ù‡'||r.operation===opFilter) &&
      (!compFilter||(r.company && r.company.toLowerCase().includes(compFilter))) &&
      (!search||
        (r.product && r.product.toLowerCase().includes(search)) ||
        (r.serial && r.serial.toLowerCase().includes(search)))
    );
    
    const thRow=document.getElementById('thead_row'); 
    thRow.innerHTML=''; 
    
    const cols=['ID','ØªØ§Ø±ÛŒØ®','Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡','Ú©Ø§Ù„Ø§','Ø¹Ù…Ù„ÛŒØ§Øª','ØªØ¹Ø¯Ø§Ø¯','Ø³Ø±ÛŒØ§Ù„','Ø´Ø±Ú©Øª','ØªØ­ÙˆÛŒÙ„â€ŒØ¯Ù‡Ù†Ø¯Ù‡','ØªØ­ÙˆÛŒÙ„â€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡','Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡','ØªÙˆØ¶ÛŒØ­Ø§Øª','Ø¹Ù…Ù„ÛŒØ§Øª'];
    cols.forEach(c=>{
      const th=document.createElement('th'); 
      th.textContent=c; 
      thRow.appendChild(th);
    });
    
    const tbody=document.getElementById('records_body'); 
    tbody.innerHTML='';
    
    data.forEach(r=>{
      const tr=document.createElement('tr');
      
      const fields = ['id','date_sh','registerer','product','operation','amount','serial','company','deliverer','receiver','employer_rep','description'];
      fields.forEach(f=>{
        const td=document.createElement('td'); 
        td.textContent=r[f]||''; 
        
        if (f === 'id' && r.synced === false) {
          td.style.color = 'orange';
          td.title = 'Ù‡Ù†ÙˆØ² Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡';
        }
        
        tr.appendChild(td);
      });
      
      const td=document.createElement('td'); 
      
      const btnEdit=document.createElement('button'); 
      btnEdit.textContent='ÙˆÛŒØ±Ø§ÛŒØ´'; 
      btnEdit.onclick=()=>editRecord(r);
      btnEdit.style.marginLeft = '5px';
      
      const btnDel=document.createElement('button'); 
      btnDel.textContent='Ø­Ø°Ù'; 
      btnDel.className='danger'; 
      btnDel.onclick=async()=>{
        if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')){
          try {
            const tx=db.transaction(['records'],'readwrite');
            tx.objectStore('records').delete(r.id);
            tx.oncomplete=()=>{
              renderList(); 
              calcBalance(); 
              renderCharts();
              showSuccess('Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯');
            };
          } catch (error) {
            showError('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯', error.message);
          }
        }
      };
      
      td.appendChild(btnEdit); 
      td.appendChild(btnDel); 
      tr.appendChild(td);
      
      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª:', error);
    showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª', error.message);
  }
}

function editRecord(r){
  editingId=r.id;
  
  const fields = {
    'date_sh': r.date_sh || '',
    'registerer': r.registerer || '',
    'operation': r.operation || '',
    'product_select': r.product || '',
    'serial': r.serial || '',
    'amount': r.amount || '',
    'company': r.company || '',
    'deliverer': r.deliverer || '',
    'receiver': r.receiver || '',
    'employer_rep': r.employer_rep || '',
    'description': r.description || ''
  };
  
  Object.keys(fields).forEach(fieldId => {
    const element = document.getElementById(fieldId);
    if (element) {
      element.value = fields[fieldId];
      
      if (fieldId === 'registerer' || fieldId === 'product_select' || fieldId === 'operation') {
        for (let option of element.options) {
          if (option.value === fields[fieldId]) {
            option.selected = true;
            break;
          }
        }
      }
    }
  });
  
  document.getElementById('saveBtn').textContent='Ø°Ø®ÛŒØ±Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´';
  document.getElementById('cancelEditBtn').style.display='inline-block';
}

async function loadUsers(){
  try {
    const all=await getAllUsers(); 
    const sel=document.getElementById('registerer'); 
    sel.innerHTML='<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>';
    
    all.forEach(u=>{
      const op=document.createElement('option'); 
      op.value=u.name; 
      op.textContent=u.name; 
      sel.appendChild(op);
    });
    
    const div=document.getElementById('user_controls'); 
    div.innerHTML=''; 
    
    all.forEach(u=>{
      const d=document.createElement('div'); 
      d.className='manage-item';
      
      const inp=document.createElement('input'); 
      inp.value=u.name; 
      inp.onchange=()=>updateUser(u.id,inp.value);
      
      const btn=document.createElement('button'); 
      btn.textContent='Ø­Ø°Ù'; 
      btn.className='danger'; 
      btn.onclick=()=>{
        if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
          deleteUser(u.id).then(loadUsers);
        }
      };
      
      d.appendChild(inp); 
      d.appendChild(btn); 
      div.appendChild(d);
    });
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:', error);
    showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', error.message);
  }
}

async function addUserFromInput(){
  const v=document.getElementById('new_user_input').value.trim(); 
  if(v){
    try {
      await addUser(v); 
      document.getElementById('new_user_input').value=''; 
      loadUsers();
      showSuccess('Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
    } catch (error) {
      showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±', error.message);
    }
  }
}

async function loadProductsToSelect(){
  try {
    const all=await getAllProducts(); 
    const sel=document.getElementById('product_select'); 
    sel.innerHTML='<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>';
    
    all.forEach(p=>{
      const op=document.createElement('option'); 
      op.value=p.name; 
      op.textContent=p.name; 
      sel.appendChild(op);
    });
    
    const div=document.getElementById('product_controls'); 
    div.innerHTML=''; 
    
    all.forEach(p=>{
      const d=document.createElement('div'); 
      d.className='manage-item';
      
      const inp=document.createElement('input'); 
      inp.value=p.name; 
      inp.onchange=()=>updateProduct(p.id,inp.value).then(loadProductsToSelect);
      
      const btn=document.createElement('button'); 
      btn.textContent='Ø­Ø°Ù'; 
      btn.className='danger'; 
      btn.onclick=()=>{
        if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø§Ù„Ø§ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
          deleteProduct(p.id).then(loadProductsToSelect);
        }
      };
      
      d.appendChild(inp); 
      d.appendChild(btn); 
      div.appendChild(d);
    });
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù„Ø§Ù‡Ø§:', error);
    showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù„Ø§Ù‡Ø§', error.message);
  }
}

async function addProductFromModal(){
  const v=document.getElementById('newProductModal').value.trim(); 
  if(v){
    try {
      await addProduct(v); 
      document.getElementById('newProductModal').value=''; 
      renderProductModal(); 
      loadProductsToSelect();
      showSuccess('Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
    } catch (error) {
      showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù„Ø§', error.message);
    }
  }
}

function openProductsPanel(){
  document.getElementById('productModal').style.display='flex'; 
  renderProductModal();
}

function closeProductModal(){
  document.getElementById('productModal').style.display='none';
}

async function renderProductModal(){
  try {
    const all=await getAllProducts(); 
    const div=document.getElementById('productListModal'); 
    div.innerHTML=''; 
    
    all.forEach(p=>{
      const d=document.createElement('div'); 
      d.className='manage-item';
      
      const inp=document.createElement('input'); 
      inp.value=p.name; 
      inp.style.width='60%'; 
      inp.onchange=()=>updateProduct(p.id,inp.value).then(renderProductModal).then(loadProductsToSelect);
      
      const del=document.createElement('button'); 
      del.textContent='Ø­Ø°Ù'; 
      del.className='danger'; 
      del.style.marginLeft='6px'; 
      del.onclick=()=>{
        if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø§Ù„Ø§ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')){
          deleteProduct(p.id).then(renderProductModal).then(loadProductsToSelect);
        }
      };
      
      d.appendChild(inp); 
      d.appendChild(del); 
      div.appendChild(d);
    });
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§:', error);
  }
}

async function exportJSON(){
  try {
    const data=await getAllRecords(); 
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); 
    const url=URL.createObjectURL(blob); 
    const a=document.createElement('a'); 
    a.href=url; 
    a.download='backup_anbar_' + new Date().toISOString().slice(0,10) + '.json'; 
    a.click();
    addToSyncLog('info', 'Ø®Ø±ÙˆØ¬ÛŒ JSON', `${data.length} Ø±Ú©ÙˆØ±Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`);
    showSuccess('ÙØ§ÛŒÙ„ JSON Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
  } catch (error) {
    showError('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ JSON', error.message);
  }
}

async function importJSON(){
  const inp=document.createElement('input'); 
  inp.type='file'; 
  inp.accept='.json'; 
  inp.onchange=async e=>{
    const file=e.target.files[0]; 
    try {
      const text=await file.text(); 
      const data=JSON.parse(text); 
      
      showSyncModal('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ', 'Ø¯Ø± Ø­Ø§Ù„ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...', true);
      updateProgress(0);
      
      const total = data.length;
      for(let i = 0; i < data.length; i++) {
        const r = data[i];
        await addRecordToDb(r); 
        updateProgress((i + 1) / total * 100);
      }
      
      updateProgress(100);
      addToSyncLog('info', 'ÙˆØ±ÙˆØ¯ÛŒ JSON', `${total} Ø±Ú©ÙˆØ±Ø¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯`);
      showSyncModal('Ù…ÙˆÙÙ‚ÛŒØª', `<div class="success-box"><strong>${total} Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯.</strong></div>`);
      
      renderList(); 
      calcBalance(); 
      renderCharts();
    } catch (error) {
      showSyncModal('Ø®Ø·Ø§', `<div class="error-box"><strong>Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„:</strong> ${error.message}</div>`);
    }
  }; 
  inp.click();
}

async function exportXLSX(){
  try {
    const data=await getAllRecords(); 
    const ws=XLSX.utils.json_to_sheet(data); 
    const wb=XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb,ws,"Records"); 
    XLSX.writeFile(wb,"records_" + new Date().toISOString().slice(0,10) + ".xlsx");
    addToSyncLog('info', 'Ø®Ø±ÙˆØ¬ÛŒ Excel', `${data.length} Ø±Ú©ÙˆØ±Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`);
    showSuccess('ÙØ§ÛŒÙ„ Excel Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
  } catch (error) {
    showError('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Excel', error.message);
  }
}

async function exportPDF(){
  try {
    const { jsPDF } = window.jspdf; 
    const doc = new jsPDF(); 
    const data=await getAllRecords(); 
    
    doc.setFontSize(16);
    doc.text('Ú¯Ø²Ø§Ø±Ø´ Ø³ÛŒØ³ØªÙ… Ø§Ù†Ø¨Ø§Ø±', 105, 10, { align: 'center' });
    doc.setFontSize(10);
    
    let y=20;
    data.forEach((r, index)=>{
      doc.text(`${index+1}. ${r.date_sh || ''} | ${r.product || ''} | ${r.operation || ''} | ${r.amount || ''} | ${r.serial || ''}`, 10, y);
      y+=6;
      if(y>280){
        doc.addPage(); 
        y=10;
      }
    }); 
    
    doc.save('records_' + new Date().toISOString().slice(0,10) + '.pdf');
    addToSyncLog('info', 'Ø®Ø±ÙˆØ¬ÛŒ PDF', `${data.length} Ø±Ú©ÙˆØ±Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`);
    showSuccess('ÙØ§ÛŒÙ„ PDF Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
  } catch (error) {
    showError('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ PDF', error.message);
  }
}

function clearFilters(){
  document.getElementById('search').value=''; 
  document.getElementById('filter_op').value='Ù‡Ù…Ù‡'; 
  document.getElementById('filter_comp').value=''; 
  renderList();
}

async function calcBalance(){
  try {
    const all=await getAllRecords(); 
    let total=0; 
    all.forEach(r=>{
      if(r.operation==='ÙˆØ±ÙˆØ¯ Ú©Ø§Ù„Ø§' || r.operation==='ØªØ­ÙˆÛŒÙ„ Ø§Ø² ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡' || r.operation==='ØªØ¹Ù…ÛŒØ± Ø´Ø¯Ù‡') {
        total+=r.amount;
      } else {
        total-=r.amount;
      }
    }); 
    
    document.getElementById('total_parts').textContent=total.toString();
    
    if (total < 0) {
      document.getElementById('total_parts').style.color = 'red';
    } else {
      document.getElementById('total_parts').style.color = 'green';
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø²:', error);
    showError('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ±Ø§Ø²', error.message);
  }
}

let pieChart=null, barChart=null;
async function renderCharts(){
  try {
    const all=await getAllRecords();
    
    const companies={}; 
    all.forEach(r=>{
      if(r.company && r.company.trim() !== ''){
        companies[r.company]=(companies[r.company]||0)+r.amount;
      }
    });
    
    const topCompanies=Object.entries(companies).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const ctx=document.getElementById('companyPie').getContext('2d');
    
    if(pieChart) pieChart.destroy();
    
    if (topCompanies.length > 0) {
      pieChart=new Chart(ctx,{
        type:'pie',
        data:{
          labels:topCompanies.map(x=>x[0]),
          datasets:[{
            data:topCompanies.map(x=>x[1]),
            backgroundColor:['#0b74de','#e76f51','#2a9d8f','#f4a261','#8d99ae']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'left',
              rtl: true
            }
          }
        }
      });
    }

    const items={}; 
    all.forEach(r=>{
      if(r.product && r.product.trim() !== ''){
        items[r.product]=(items[r.product]||0)+r.amount;
      }
    });
    
    const topItems=Object.entries(items).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const ctx2=document.getElementById('topItemsBar').getContext('2d');
    
    if(barChart) barChart.destroy();
    
    if (topItems.length > 0) {
      barChart=new Chart(ctx2,{
        type:'bar',
        data:{
          labels:topItems.map(x=>x[0]),
          datasets:[{
            label:'ØªØ¹Ø¯Ø§Ø¯',
            data:topItems.map(x=>x[1]),
            backgroundColor:'#0b74de'
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: {
                font: {
                  family: 'Estedad'
                }
              }
            },
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§:', error);
  }
}

async function clearAllData() {
  if (confirm('âš ï¸ Ù‡Ø´Ø¯Ø§Ø±! Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.')) {
    if (confirm('âš ï¸ ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ØŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ú©Ø§Ù„Ø§Ù‡Ø§ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯.')) {
      try {
        await clearStore();
        addToSyncLog('warning', 'Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', 'ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
        await loadUsers();
        await loadProductsToSelect();
        await renderList();
        await calcBalance();
        await renderCharts();
        showSyncModal('Ù…ÙˆÙÙ‚ÛŒØª', `<div class="success-box"><strong>ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.</strong></div>`);
      } catch (error) {
        showError('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', error.message);
      }
    }
  }
}

// ==================== Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ ====================
async function checkConnection(showModal = true) {
  if (showModal) {
    showSyncModal('Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„', 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...', true);
    updateProgress(50);
  }
  
  try {
    const connected = await initSupabase();
    
    if (showModal) {
      updateProgress(100);
    }
    
    if (connected) {
      addToSyncLog('success', 'Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚', 'Ø³Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª');
      
      if (showModal) {
        showSyncModal('Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚', `
          <div class="success-box" style="text-align:right;">
            <strong>âœ… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Supabase Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯.</strong><br>
            <small>ğŸŒ Ø³Ø±ÙˆØ±: ${SUPABASE_URL.replace('https://', '')}</small><br>
            <small>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù†Ù„Ø§ÛŒÙ†</small>
          </div>
        `);
      }
      
      showSuccess('Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯');
      return true;
    } else {
      addToSyncLog('warning', 'Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚', 'Ø³Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª');
      
      if (showModal) {
        showSyncModal('Ø§ØªØµØ§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚', `
          <div class="warning-box" style="text-align:right;">
            <strong>âš ï¸ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.</strong><br>
            <small>ğŸ”Œ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.</small><br>
            <small>ğŸŒ Ø³Ø±ÙˆØ±: ${SUPABASE_URL.replace('https://', '')}</small>
          </div>
        `);
      }
      
      showError('Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª');
      return false;
    }
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„:', error);
    addToSyncLog('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„', error.message);
    
    if (showModal) {
      showSyncModal('Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„', `
        <div class="error-box">
          <strong>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„:</strong> ${error.message}<br>
          <hr style="margin:5px 0">
          <small>${error.toString()}</small>
        </div>
      `);
    }
    
    return false;
  }
}

// Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
document.addEventListener('DOMContentLoaded', initApp);
</script>

</body>
</html>